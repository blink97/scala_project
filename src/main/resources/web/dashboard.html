<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Visualisation des données</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.min.js"></script>
</head>
<body>

<div class="container">
    <h2>Données des drones</h2>
    <p></p>
    <canvas class="my-4 chartjs-render-monitor" id="myChart" width="659" height="278" style="display: block; width: 659px; height: 278px;"></canvas>

    <table class="table table-striped table-bordered" id="dt">
        <thead>
        <tr>
            <th>Drone ID</th>
            <th>Message</th>
            <th>Date</th>
            <th>Temperature (°C)</th>
            <th>Position (X, Y, Altitude)</th>
        </tr>
        </thead>
        <tbody id="tableau">
        </tbody>
    </table>
</div>
<!-- Script de gestion du tableau -->
<script>
    function processRequest(e) {
        if (xhr.readyState == 4 && xhr.status == 200) {
            var json = xhr.responseText
            json = json.replace(/(?:\r\n|\r|\n)/g, ',')
            json = '{"tab":[' + json + ']}'
            trueJson = JSON.parse(json)
            console.log(trueJson)
            list4Chart = new Array()
            labels = []
            tempsOK = []
            tempsERROR = []
            tempsHOT = []
            tempsCOLD = []

            for (var i = 0; i < trueJson.tab.length; i++) {
                var array = trueJson.tab[i];
                var tr = document.createElement("tr");
                var tdDroneId = document.createElement("td");
                var tdMessage = document.createElement("td");
                var tdTime = document.createElement("td");
                var tdTemp = document.createElement("td");
                var tdGeoPos = document.createElement("td");

                //Create row for tables
                tdDroneId.appendChild(document.createTextNode(array.droneId));
                tdMessage.appendChild(document.createTextNode(array.msgType));
                tdTime.appendChild(document.createTextNode(array.time));
                tdTemp.appendChild(document.createTextNode(array.temp));
                tdGeoPos.appendChild(document.createTextNode(array.geoPos.x + ', ' + array.geoPos.y + ', ' + array.geoPos.alt));


                //Create data for chart
                list4Chart[i] = {};
                list4Chart[i]['labels'] = new Date(array.time.substring(0, 22));
                if (array.msgType.substring(0,2) == "OK") {
                    list4Chart[i]['tempsOK'] = array.temp;
                    list4Chart[i]['tempsERROR'] = NaN;
                    list4Chart[i]['tempsHOT'] = NaN;
                    list4Chart[i]['tempsCOLD'] = NaN;
                }
                else if (array.msgType.substring(0,5) == "ERROR") {
                    list4Chart[i]['tempsOK'] = NaN;
                    list4Chart[i]['tempsERROR'] = array.temp;
                    list4Chart[i]['tempsHOT'] = NaN;
                    list4Chart[i]['tempsCOLD'] = NaN;
                }
                else if (array.msgType.substring(0,3) == "HOT") {
                    list4Chart[i]['tempsOK'] = NaN;
                    list4Chart[i]['tempsERROR'] = NaN;
                    list4Chart[i]['tempsHOT'] = array.temp;
                    list4Chart[i]['tempsCOLD'] = NaN;
                }
                else if (array.msgType.substring(0,4) == "COLD") {
                    list4Chart[i]['tempsOK'] = NaN;
                    list4Chart[i]['tempsERROR'] = NaN;
                    list4Chart[i]['tempsHOT'] = NaN;
                    list4Chart[i]['tempsCOLD'] = array.temp;
                }



                //Adding in tables
                tr.appendChild(tdDroneId);
                tr.appendChild(tdMessage);
                tr.appendChild(tdTime);
                tr.appendChild(tdTemp);
                tr.appendChild(tdGeoPos);
                var tableau = document.getElementById("tableau");
                tableau.appendChild(tr);
            }

            $(document).ready(function () {
                $('#dt').DataTable();
            });


            list4Chart.sort(function(x, y){
                return x.labels - y.labels;
            })

            for (var j = 0; j < list4Chart.length; j++) {
                labels.push(list4Chart[j]['labels'])
                tempsOK.push(list4Chart[j]['tempsOK'])
                tempsERROR.push(list4Chart[j]['tempsERROR'])
                tempsHOT.push(list4Chart[j]['tempsHOT'])
                tempsCOLD.push(list4Chart[j]['tempsCOLD'])
            }

            console.log(tempsOK);
            console.log(tempsERROR);
            console.log(tempsHOT);
            console.log(tempsCOLD);
            var ctx = document.getElementById("myChart");
            var myChart = new Chart(ctx, {
                type: 'line',
                data: {
                  labels: labels,
                  datasets: [{
                    data: tempsOK,
                    lineTension: 0,
                    backgroundColor: 'transparent',
                    borderColor: '#00ff00',
                    borderWidth: 4,
                    pointBackgroundColor: '#00ff00'
                  },{
                    data: tempsERROR,
                    lineTension: 0,
                    backgroundColor: 'transparent',
                    borderColor: '#ff0000',
                    borderWidth: 4,
                    pointBackgroundColor: '#ff0000'
                  },{
                    data: tempsHOT,
                    lineTension: 0,
                    backgroundColor: 'transparent',
                    borderColor: '#ffa500',
                    borderWidth: 4,
                    pointBackgroundColor: '#ffa500'
                  },{
                    data: tempsCOLD,
                    lineTension: 0,
                    backgroundColor: 'transparent',
                    borderColor: '#0000ff',
                    borderWidth: 4,
                    pointBackgroundColor: '#0000ff'
                  }]
                },
                options: {
                  spanGaps : true,
                  scales: {
                    yAxes: [{
                      ticks: {
                        beginAtZero: false
                      }
                    }],
                    xAxes: [{
                        type: 'time',
                        time: {
                            displayFormats: {
                                quarter: 'MMM YYYY'
                            }
                        }
                    }]
                  },
                  legend: {
                    display: false,
                  }
                }
              });
        }
    }
    var xhr = new XMLHttpRequest();
    xhr.open( "GET", "http://localhost:8080/msg");
    xhr.send();

    xhr.onreadystatechange = processRequest;
</script>
</body>
</html>